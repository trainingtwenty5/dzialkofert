<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dodaj Ogłoszenie z Działek</title>
	
    <!-- Favicon dla przeglądarek -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://storage.waw.cloud.ovh.net/v1/AUTH_024f82ed62da4186825a5b526cd1a61e/FishFounder/Dzialkofert_logo.png">

	
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBdhMIiqetOfDGP85ERxtgwn3AXR50pBcE",
            authDomain: "base-468e0.firebaseapp.com",
            projectId: "base-468e0",
            storageBucket: "base-468e0.firebasestorage.app",
            messagingSenderId: "829161895559",
            appId: "1:829161895559:web:d832541aac05b35847ea22"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        
        // Udostępnij Firestore globalnie do użycia w innych funkcjach
        window.db = db;
        window.addDoc = addDoc;
        window.collection = collection;
    </script>
    
    <style>
        :root {
            --primary-blue: #1e6fba;
            --primary-dark: #155d9d;
            --secondary-blue: #2c8ac9;
            --accent-blue: #3ba3e3;
            --light-blue: #e6f2ff;
            --lighter-blue: #f0f8ff;
            --success-blue: #2e94cc;
        }
        
        body {
            background-color: var(--lighter-blue);
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #map {
            height: 500px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            z-index: 1;
        }
        
        .form-check-label {
            white-space: normal;
            line-height: 1.3rem;
            width: 100%;
        }
        
        .map-error {
            color: #dc3545;
            padding: 15px;
            background-color: #f8d7da;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            flex-direction: column;
            background-color: var(--light-blue);
            border-radius: 8px;
        }
        
        .spinner-border {
            margin-bottom: 10px;
            color: var(--primary-blue);
        }
        
        .instructions {
            background-color: var(--light-blue);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-blue);
        }
        
        #selectedPlots {
            background-color: var(--light-blue);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border: 1px solid var(--secondary-blue);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .btn-primary {
            background-color: var(--primary-blue);
            border-color: var(--primary-blue);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }
        
        .form-control:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 0.25rem rgba(30, 111, 186, 0.25);
        }
        
        .form-check-input:checked {
            background-color: var(--primary-blue);
            border-color: var(--primary-blue);
        }
        
        .alert-info {
            background-color: var(--light-blue);
            border-color: var(--secondary-blue);
            color: var(--primary-dark);
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        
        h1, h2 {
            color: var(--primary-blue);
            font-weight: 600;
        }
        
        .form-label {
            font-weight: 500;
            color: var(--primary-dark);
        }
        
        #plotInfo {
            background-color: var(--lighter-blue);
            border-left: 4px solid var(--accent-blue);
        }
        
        .plot-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: #e9ecef;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .plot-item:hover {
            background: #dee2e6;
        }
        
        .map-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        
        .map-container {
            position: relative;
        }
        
        .plot-details {
            font-size: 0.85rem;
            margin-top: 5px;
            color: #666;
        }
        
        .highlighted {
            background-color: #fff3cd !important;
            border: 1px solid #ffeaa7;
        }
        
        .connection-status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 0.9rem;
        }
        
        .point-marker {
            background-color: var(--primary-blue);
            border: 2px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        
        .gm-style .gm-style-iw {
            padding: 10px;
        }
    </style>
</head>
<body onload="loadGoogleMaps()">
    <div class="toast-container"></div>
    
    <div class="container pt-4 pb-4">
        <div class="row justify-content-center">
            <div class="col-12">
                <h1 class="text-center mb-3">Dodaj Ogłoszenie z Działek</h1>
                <p class="lead text-center mb-4">Kliknij na mapę, aby wskazać lokalizację działki</p>
                
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Wskazane Lokalizacje</h5>
                    </div>
                    <div class="card-body">
                        <div id="selectedPlots">
                            <p class="text-muted">Brak wskazanych lokalizacji. Kliknij na mapie, aby dodać punkty.</p>
                        </div>
                    </div>
                </div>
                
                <div class="map-error" id="mapError" style="display: none;">
                    <h5>Błąd ładowania mapy</h5>
                    <p id="errorMessage"></p>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="map-container mb-4">
                            <div id="map"></div>
                            <div class="map-overlay">
                                <div class="btn-group-vertical">
                                    <button id="clearPlotsBtn" class="btn btn-sm btn-warning mb-2">Wyczyść punkty</button>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoSave">
                                        <label class="form-check-label" for="autoSave" style="font-size: 12px;">
                                            Auto-zapis
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="connection-status" id="connectionStatus">
                                Status: <span class="text-success">Połączono z serwerem</span>
                            </div>
                            <div class="loading" id="mapLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Ładowanie mapy...</span>
                                </div>
                                <p>Ładowanie mapy...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Formularz ogłoszenia</h5>
                            </div>
                            <div class="card-body">
                                <form id="propertyForm">
                                    <div class="mb-3">
                                        <label for="city" class="form-label">Miejscowość</label>
                                        <input type="text" class="form-control" id="city" placeholder="Miejscowość, gdzie znajduje się działka">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="firstName" class="form-label">Imię *</label>
                                        <input type="text" class="form-control" id="firstName" required placeholder="Podaj swoje imię">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="phone" class="form-label">Telefon *</label>
                                        <input type="tel" class="form-control" id="phone" required 
                                               pattern="[0-9]{9}|\+[1-9][0-9]{8,}" 
                                               placeholder="Np. 123456789 lub +48123456789">
                                        <div class="form-text">Numer telefonu: 9 cyfr lub numer ze znakiem +</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="email" class="form-label">E-mail</label>
                                        <input type="email" class="form-control" id="email" placeholder="Twój adres email">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="price" class="form-label">Cena (zł)</label>
                                        <input type="number" class="form-control" id="price" placeholder="Podaj cenę działki">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllConsent">
                                            <label class="form-check-label" for="selectAllConsent">
                                                Zaznacz wszystkie zgody
                                            </label>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input class="form-check-input consent-checkbox" type="checkbox" id="termsConsent" required>
                                            <label class="form-check-label" for="termsConsent">
                                                Zapoznałem się z regulaminem i polityką prywatności oraz akceptuję ich treść *
                                            </label>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input class="form-check-input consent-checkbox" type="checkbox" id="marketingConsent">
                                            <label class="form-check-label" for="marketingConsent">
                                                Chcę otrzymywać informacje marketingowe dotyczące ofert działek
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary w-100" id="submitButton">
                                        <span class="spinner-border spinner-border-sm" id="submitSpinner" style="display: none;"></span>
                                        <span id="submitText">Zapisz do bazy danych</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Funkcja do ładowania Google Maps API
        function loadGoogleMaps() {
            const apiKey = localStorage.getItem('googleMapsApiKey') || 'AIzaSyCr5TmFxnT3enxmyr6vujF8leP995giw8I';
            const script = document.createElement("script");
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        // Zmienne globalne
        let map, geocoder;
        let selectedPoints = [];
        let pointMarkers = [];
        let currentHighlighted = null;
        
        // Inicjalizacja mapy Google
        function initMap() {
            // Inicjalizacja mapy z centrum na Polsce
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 52.0, lng: 19.0 },
                zoom: 7,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
            
            // Inicjalizacja geokodera
            geocoder = new google.maps.Geocoder();
            
            // Obsługa kliknięcia na mapie
            map.addListener('click', function(e) {
                // Dodaj punkt na mapie
                addPointToSelection(e.latLng);
            });
            
            // Ukryj loading, pokaż mapę
            document.getElementById('mapLoading').style.display = 'none';
            document.getElementById('mapError').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            
            showToast("Mapa załadowana pomyślnie. Kliknij na mapie, aby dodać punkt.", "success");
        }
        
        // Dodawanie punktu do listy wybranych
        function addPointToSelection(latLng) {
            // Sprawdź, czy punkt już istnieje na liście (z tolerancją 0.0001 stopnia)
            const existingIndex = selectedPoints.findIndex(point => 
                Math.abs(point.lat - latLng.lat()) < 0.0001 && 
                Math.abs(point.lng - latLng.lng()) < 0.0001
            );
            
            if (existingIndex === -1) {
                // Generuj unikalny identyfikator dla punktu
                const pointId = 'point_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Dodaj nowy punkt
                const pointData = {
                    id: pointId,
                    lat: latLng.lat(),
                    lng: latLng.lng(),
                    timestamp: new Date().toISOString()
                };
                
                selectedPoints.push(pointData);
                
                // Dodaj znacznik na mapę
                const marker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: '#1e6fba',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2,
                        scale: 8
                    }
                });
                
                // Dodajemy obsługę kliknięcia na znacznik
                marker.addListener('click', function() {
                    // Usuń ten punkt
                    removePoint(pointId);
                });
                
                // Dodajemy info window do markera
                const infoWindow = new google.maps.InfoWindow({
                    content: `<b>Punkt lokalizacji</b><br>Współrzędne: ${latLng.lat().toFixed(6)}, ${latLng.lng().toFixed(6)}`
                });
                
                marker.addListener('mouseover', function() {
                    infoWindow.open(map, marker);
                });
                
                marker.addListener('mouseout', function() {
                    infoWindow.close();
                });
                
                pointMarkers.push({
                    id: pointId,
                    marker: marker,
                    infoWindow: infoWindow
                });
                
                showToast(`Dodano punkt lokalizacji`, "success");
            } else {
                // Usuń istniejący punkt
                removePoint(selectedPoints[existingIndex].id);
                return;
            }
            
            updateSelectedPointsList();
            
            // Automatyczny zapis jeśli opcja jest włączona
            if ($('#autoSave').is(':checked') && selectedPoints.length > 0) {
                saveToDatabase();
            }
        }
        
        // Aktualizacja listy wybranych punktów
        function updateSelectedPointsList() {
            const container = $('#selectedPlots');
            if (selectedPoints.length === 0) {
                container.html('<p class="text-muted">Brak wskazanych lokalizacji. Kliknij na mapie, aby dodać punkty.</p>');
                $('#submitButton').prop('disabled', true);
                return;
            }
            
            let html = '';
            selectedPoints.forEach((point, index) => {
                html += `
                    <div class="plot-item" data-point-id="${point.id}">
                        <div>
                            <strong>Punkt ${index + 1}</strong>
                            <div class="plot-details">
                                Współrzędne: ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}<br>
                                Dodano: ${new Date(point.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-danger btn-action" onclick="removePoint('${point.id}')">Usuń</button>
                    </div>
                `;
            });
            
            container.html(html);
            $('#submitButton').prop('disabled', false);
            
            // Dodanie obsługi najazdu na element listy
            $('.plot-item').hover(
                function() {
                    const pointId = $(this).data('point-id');
                    highlightPoint(pointId, true);
                },
                function() {
                    const pointId = $(this).data('point-id');
                    highlightPoint(pointId, false);
                }
            );
        }
        
        // Podświetlanie punktu na mapie przy najechaniu na element listy
        function highlightPoint(pointId, highlight) {
            // Znajdź znacznik odpowiadający punktowi
            const markerInfo = pointMarkers.find(marker => marker.id === pointId);
            if (markerInfo && highlight) {
                // Zmień wygląd znacznika
                markerInfo.marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#ff6b35',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    scale: 8
                });
                
                // Otwórz popup
                markerInfo.infoWindow.open(map, markerInfo.marker);
                
                // Podświetl również element listy
                $(`.plot-item[data-point-id="${pointId}"]`).addClass('highlighted');
            } else if (markerInfo) {
                // Przywróć domyślny wygląd znacznika
                markerInfo.marker.setIcon({
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#1e6fba',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    scale: 8
                });
                
                // Zamknij popup
                markerInfo.infoWindow.close();
                
                $(`.plot-item[data-point-id="${pointId}"]`).removeClass('highlighted');
            }
        }
        
        // Usuwanie punktu z listy
        function removePoint(pointId) {
            const index = selectedPoints.findIndex(point => point.id === pointId);
            if (index !== -1) {
                const point = selectedPoints[index];
                selectedPoints.splice(index, 1);
                
                // Usuń znacznik z mapy
                const markerIndex = pointMarkers.findIndex(marker => marker.id === pointId);
                if (markerIndex !== -1) {
                    pointMarkers[markerIndex].marker.setMap(null);
                    pointMarkers.splice(markerIndex, 1);
                }
                
                updateSelectedPointsList();
                showToast(`Usunięto punkt lokalizacji`, "info");
            }
        }
        
        // Zapisywanie do bazy danych Firebase
        async function saveToDatabase() {
            if (selectedPoints.length === 0) {
                showToast("Brak punktów do zapisania", "warning");
                return;
            }
            
            // Walidacja formularza
            if (!validateForm()) {
                showToast("Proszę wypełnić wymagane pola formularza", "warning");
                return;
            }
            
            $('#submitSpinner').show();
            $('#submitText').text('Zapisywanie...');
            $('#submitButton').prop('disabled', true);
            
            try {
                // Przygotuj dane do zapisania
                const formData = {
                    city: document.getElementById("city").value,
                    firstName: document.getElementById("firstName").value,
                    phone: document.getElementById("phone").value,
                    email: document.getElementById("email").value,
                    price: document.getElementById("price").value,
                    plots: selectedPoints.map(point => ({
                        Id: "",
                        idDzialki_uldk: "",
                        lat: point.lat,
                        lng: point.lng,
                        mock: true,
                        geometry_uldk: null,
                        pow_dzialki_m2_uldk: null,
                        price: document.getElementById("price").value || "",
                        termsConsent: document.getElementById("termsConsent").checked,
                        timestamp: new Date()
                    })),
                    termsConsent: document.getElementById("termsConsent").checked,
                    marketingConsent: document.getElementById("marketingConsent").checked,
                    timestamp: new Date()
                };
                
                // Zapisz dane w Firebase Firestore
                const docRef = await window.addDoc(window.collection(window.db, "propertyListings"), formData);
                console.log("Dokument zapisany z ID: ", docRef.id);
                
                // Pokaż sukces
                showToast("Dane zostały pomyślnie zapisane do bazy danych!", "success");
                
                // Wyczyść listę punktów
                clearPoints();
                
            } catch (error) {
                console.error("Błąd podczas zapisywania: ", error);
                showToast("Wystąpił błąd podczas zapisywania danych: " + error.message, "error");
            } finally {
                // Ukryj spinner
                $('#submitSpinner').hide();
                $('#submitText').text('Zapisz do bazy danych');
                $('#submitButton').prop('disabled', false);
            }
        }
        
        // Walidacja formularza
        function validateForm() {
            const firstName = document.getElementById("firstName").value;
            const phone = document.getElementById("phone").value;
            const termsConsent = document.getElementById("termsConsent").checked;
            
            return firstName && phone && termsConsent;
        }
        
        // Czyszczenie listy punktów
        function clearPoints() {
            // Usuń wszystkie znaczniki z mapy
            pointMarkers.forEach(markerInfo => {
                markerInfo.marker.setMap(null);
            });
            
            // Wyczyść tablice
            selectedPoints = [];
            pointMarkers = [];
            currentHighlighted = null;
            
            // Zaktualizuj UI
            updateSelectedPointsList();
        }
        
        // Wyświetlanie powiadomień
        function showToast(message, type = "info") {
            const toast = $(`
                <div class="toast align-items-center text-white bg-${type}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `);
            
            $('.toast-container').append(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Usuwanie toastu po zakończeniu animacji
            toast.on('hidden.bs.toast', function() {
                toast.remove();
            });
        }
        
        // Inicjalizacja po załadowaniu DOM
        $(document).ready(function() {
            // Obsługa przycisku czyszczenia listy
            $('#clearPlotsBtn').click(function() {
                if (selectedPoints.length > 0) {
                    if (confirm("Czy na pewno chcesz wyczyścić listę punktów?")) {
                        clearPoints();
                        showToast("Wyczyszczono listę punktów", "info");
                    }
                } else {
                    showToast("Lista punktów jest pusta", "info");
                }
            });
            
            // Obsługa zaznaczania wszystkich zgód
            $("#selectAllConsent").click(function() {
                $(".consent-checkbox").prop('checked', $(this).prop('checked'));
            });
            
            // Obsługa formularza
            $("#propertyForm").submit(function(e) {
                e.preventDefault();
                saveToDatabase();
            });
        });

        // Udostępnienie funkcji globalnie
        window.removePoint = removePoint;
    </script>
</body>
</html>